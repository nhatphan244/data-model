from tkinter import Tk, filedialog
import os
import pandas as pd
from datetime import datetime
from tqdm import tqdm

def split():
    root = Tk()
    root.withdraw()
    root.attributes('-topmost', True) 
    filename = filedialog.askopenfilename(title="Chọn file Excel cần chia")
    root.attributes('-topmost', False) 
    root.destroy()

    if not filename:
        print("Không có file nào được chọn.")
        return

    # Lấy thư mục của file
    script_dir = os.path.dirname(filename)
    folder_name = os.path.join(script_dir, "split")
    if not os.path.exists(folder_name):
        os.makedirs(folder_name)

    # Đọc excel
    df = pd.read_excel(filename)
    df_split_input = pd.read_excel(filename, sheet_name='split_input', header=None)
    num_rows_to_split = int(df_split_input.iloc[0, 1])  # Số dòng tối đa trong mỗi file
    province_flag = df_split_input.iloc[1, 1].strip().lower() == 'y'
    district_flag = df_split_input.iloc[2, 1].strip().lower() == 'y'

    if not df['Tỉnh Thành'].isnull().all():  # Kiểm tra cột Tỉnh Thành có dữ liệu không
        provinces = df['Tỉnh Thành'].unique()
        # Xử lý tách theo tỉnh hoặc tỉnh và quận
        with tqdm(total=len(provinces), desc='Đang chia file') as pbar:
            for province in provinces:
                province_df = df[df['Tỉnh Thành'] == province]
                if province_flag and not district_flag:
                    process_split(province_df, num_rows_to_split, folder_name, province)
                elif province_flag and district_flag:
                    districts = province_df['Quận'].unique()
                    for district in districts:
                        district_df = province_df[province_df['Quận'] == district]
                        process_split(district_df, num_rows_to_split, folder_name, f"{province}_{district}")
                pbar.update(1)
    else:
        print("Cột 'Tỉnh Thành' không có dữ liệu. Vui lòng kiểm tra lại.")

def process_split(df, num_rows_to_split, folder_name, label):
    total_rows = len(df)
    num_files = total_rows // num_rows_to_split
    remaining_rows = total_rows % num_rows_to_split
    with tqdm(total=num_files + (1 if remaining_rows else 0), desc=f'Đang tạo file cho {label}') as pbar:
        for i in range(num_files):
            start_row = i * num_rows_to_split
            end_row = min((i + 1) * num_rows_to_split, total_rows)
            df_subset = df.iloc[start_row:end_row, :]
            file_name = f"{label} [Từ {start_row + 1} Đến {end_row}].xlsx"
            file_path = os.path.join(folder_name, file_name)
            df_subset.to_excel(file_path, index=False)
            print(f"Tạo thành công File '{file_name}'")
            pbar.update(1)

        if remaining_rows:
            start_row = num_files * num_rows_to_split
            df_subset = df.iloc[start_row:, :]
            file_name = f"{label} [Từ {start_row + 1} Đến {total_rows}].xlsx"
            file_path = os.path.join(folder_name, file_name)
            df_subset.to_excel(file_path, index=False)
            print(f"Tạo thành công File '{file_name}'")
            pbar.update(1)
