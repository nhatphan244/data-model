from tkinter import Tk, filedialog
import os
import pandas as pd
import time
from datetime import datetime
from tqdm import tqdm

def merge():
    root = Tk()
    root.withdraw()
    root.attributes('-topmost', True)
    folder_selected = filedialog.askdirectory(title="Chọn folder chứa file(s) excel cần merge")
    root.attributes('-topmost', False)
    root.destroy()

    if not folder_selected:
        print("Không có folder được chọn.")
        return

    script_dir = os.path.dirname(__file__)
    merge_folder_path = os.path.join(script_dir, "merge")
    if not os.path.exists(merge_folder_path):
        os.makedirs(merge_folder_path)

    excel_files = [f for f in os.listdir(folder_selected) if f.endswith('.xlsx')]

    if not excel_files:
        print("Không tìm thấy file Excel trong thư mục đã chọn")
        return

    merged_df = pd.DataFrame()
    merge_log = []

    # Progress bar for merging files
    print("Merging Excel files...")
    with tqdm(total=len(excel_files), desc='Merging Files') as pbar:
        for file in excel_files:
            file_path = os.path.join(folder_selected, file)
            df = pd.read_excel(file_path)
            merge_log.append((file, len(merged_df) + 1, len(merged_df) + len(df)))
            merged_df = pd.concat([merged_df, df], ignore_index=True)
            pbar.update(1)  # Update progress for each file merged

    # Progress bar for saving the DataFrame to Excel
    print("Saving merged DataFrame to Excel...")
    with tqdm(total=1, desc='Saving Excel') as pbar:
        current_datetime = datetime.now().strftime("%d%m%Y_%H%M%S")
        merged_filename = f"{current_datetime}.xlsx"
        merged_file_path = os.path.join(merge_folder_path, merged_filename)
        merged_df.to_excel(merged_file_path, index=False)
        pbar.update(1)  # Complete the progress upon saving

    # Progress bar for writing the log file
    print("Writing merge log...")
    with tqdm(total=1, desc='Writing Log File') as pbar:
        log_filename = f"merge_log_{current_datetime}.txt"
        log_file_path = os.path.join(merge_folder_path, log_filename)
        with open(log_file_path, 'w', encoding='utf-8') as log_file:
            log_file.write("List các file được merge:\n")
            for idx, (file, start, end) in enumerate(merge_log, start=1):
                log_file.write(f"{idx}. {file}: Từ dòng {start} tới dòng {end}\n")
        pbar.update(1)  # Complete the progress upon writing the log

    print("Merge process completed successfully.")

