# Import the necessary modules
import pandas as pd
import sqlalchemy
from sqlalchemy import create_engine
from sqlalchemy.types import NVARCHAR
import openpyxl
import pyodbc
from config import excel_file, connection_string

# Load the data from the Excel file
df = pd.read_excel(excel_file)

# Define the column mappings for various dataframes
column_mapping_gov_master = {
    "System Mã Tỉnh": "province_id",
    "Thành Phố": "province_name",
    "System Mã Quận Huyện": "district_id",
    "Quận Huyện": "district_name",
    "System Ward Code": "ward_id",
    "Phường Xã": "ward_name"
}

# Prepare the dataframes
gov_master_df = df.rename(columns=column_mapping_gov_master)
gov_master_df['ward_id'] = pd.to_numeric(gov_master_df['ward_id'], errors='coerce').astype('Int64')

# Insert unsigned name columns
gov_master_df.insert(gov_master_df.columns.get_loc("province_name") + 1, "province_name_unsigned", "")
gov_master_df.insert(gov_master_df.columns.get_loc("district_name") + 1, "district_name_unsigned", "")
gov_master_df.insert(gov_master_df.columns.get_loc("ward_name") + 1, "ward_name_unsigned", "")

# Define column data types for SQL
column_data_types = {
    "province_name": NVARCHAR(length=255),
    "district_name": NVARCHAR(length=255),
    "ward_name": NVARCHAR(length=255),
    "province_name_unsigned": NVARCHAR(length=255),
    "district_name_unsigned": NVARCHAR(length=255),
    "ward_name_unsigned": NVARCHAR(length=255)
}

# Create the SQL engine
engine = create_engine(connection_string)

# Upload data to SQL Server
gov_master_df.to_sql('gov_master', engine, if_exists='replace', index=False, dtype=column_data_types)
province_df.to_sql('province', engine, if_exists='replace', index=False, dtype={"id": NVARCHAR(length=255), "province_name": NVARCHAR(length=255), "province_name_unsigned": NVARCHAR(length=255)})
district_df.to_sql('district', engine, if_exists='replace', index=False, dtype={"id": NVARCHAR(length=255), "district_name": NVARCHAR(length=255), "district_name_unsigned": NVARCHAR(length=255)})
ward_df.to_sql('ward', engine, if_exists='replace', index=False, dtype={"id": NVARCHAR(length=255), "ward_name": NVARCHAR(length=255), "ward_name_unsigned": NVARCHAR(length=255)})
